import***REMOVED***{***REMOVED***NextRequest,***REMOVED***NextResponse***REMOVED***}***REMOVED***from***REMOVED***"next/server";
import***REMOVED***type***REMOVED***{***REMOVED***HistoryItem,***REMOVED***HistoryStatus***REMOVED***}***REMOVED***from***REMOVED***"@/types";

//***REMOVED***Mock***REMOVED***data***REMOVED***for***REMOVED***demonstration***REMOVED***-***REMOVED***replace***REMOVED***with***REMOVED***actual***REMOVED***database***REMOVED***queries
const***REMOVED***mockHistoryData:***REMOVED***HistoryItem[]***REMOVED***=***REMOVED***[
***REMOVED******REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***id:***REMOVED***"task-001",
***REMOVED******REMOVED******REMOVED******REMOVED***command:***REMOVED***"Summarize***REMOVED***my***REMOVED***unread***REMOVED***emails***REMOVED***from***REMOVED***today",
***REMOVED******REMOVED******REMOVED******REMOVED***status:***REMOVED***"success",
***REMOVED******REMOVED******REMOVED******REMOVED***timestamp:***REMOVED***new***REMOVED***Date(Date.now()***REMOVED***-***REMOVED***1000***REMOVED*******REMOVED***60***REMOVED*******REMOVED***30),***REMOVED***//***REMOVED***30***REMOVED***minutes***REMOVED***ago
***REMOVED******REMOVED******REMOVED******REMOVED***duration:***REMOVED***4500,
***REMOVED******REMOVED******REMOVED******REMOVED***agentsUsed:***REMOVED***["Email***REMOVED***Agent",***REMOVED***"Analysis***REMOVED***Agent"],
***REMOVED******REMOVED******REMOVED******REMOVED***resultCount:***REMOVED***3,
***REMOVED******REMOVED***},
***REMOVED******REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***id:***REMOVED***"task-002",
***REMOVED******REMOVED******REMOVED******REMOVED***command:***REMOVED***"Create***REMOVED***a***REMOVED***meeting***REMOVED***summary***REMOVED***document***REMOVED***from***REMOVED***yesterday's***REMOVED***calendar",
***REMOVED******REMOVED******REMOVED******REMOVED***status:***REMOVED***"success",
***REMOVED******REMOVED******REMOVED******REMOVED***timestamp:***REMOVED***new***REMOVED***Date(Date.now()***REMOVED***-***REMOVED***1000***REMOVED*******REMOVED***60***REMOVED*******REMOVED***60***REMOVED*******REMOVED***2),***REMOVED***//***REMOVED***2***REMOVED***hours***REMOVED***ago
***REMOVED******REMOVED******REMOVED******REMOVED***duration:***REMOVED***6200,
***REMOVED******REMOVED******REMOVED******REMOVED***agentsUsed:***REMOVED***["Calendar***REMOVED***Agent",***REMOVED***"Drive***REMOVED***Agent",***REMOVED***"Docs***REMOVED***Agent"],
***REMOVED******REMOVED******REMOVED******REMOVED***resultCount:***REMOVED***1,
***REMOVED******REMOVED***},
***REMOVED******REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***id:***REMOVED***"task-003",
***REMOVED******REMOVED******REMOVED******REMOVED***command:***REMOVED***"Find***REMOVED***all***REMOVED***PDFs***REMOVED***in***REMOVED***my***REMOVED***Drive***REMOVED***from***REMOVED***last***REMOVED***week",
***REMOVED******REMOVED******REMOVED******REMOVED***status:***REMOVED***"failed",
***REMOVED******REMOVED******REMOVED******REMOVED***timestamp:***REMOVED***new***REMOVED***Date(Date.now()***REMOVED***-***REMOVED***1000***REMOVED*******REMOVED***60***REMOVED*******REMOVED***60***REMOVED*******REMOVED***5),***REMOVED***//***REMOVED***5***REMOVED***hours***REMOVED***ago
***REMOVED******REMOVED******REMOVED******REMOVED***duration:***REMOVED***2100,
***REMOVED******REMOVED******REMOVED******REMOVED***agentsUsed:***REMOVED***["Drive***REMOVED***Agent"],
***REMOVED******REMOVED******REMOVED******REMOVED***resultCount:***REMOVED***0,
***REMOVED******REMOVED***},
***REMOVED******REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***id:***REMOVED***"task-004",
***REMOVED******REMOVED******REMOVED******REMOVED***command:***REMOVED***"Schedule***REMOVED***a***REMOVED***team***REMOVED***meeting***REMOVED***for***REMOVED***next***REMOVED***Monday",
***REMOVED******REMOVED******REMOVED******REMOVED***status:***REMOVED***"cancelled",
***REMOVED******REMOVED******REMOVED******REMOVED***timestamp:***REMOVED***new***REMOVED***Date(Date.now()***REMOVED***-***REMOVED***1000***REMOVED*******REMOVED***60***REMOVED*******REMOVED***60***REMOVED*******REMOVED***24),***REMOVED***//***REMOVED***1***REMOVED***day***REMOVED***ago
***REMOVED******REMOVED******REMOVED******REMOVED***duration:***REMOVED***1500,
***REMOVED******REMOVED******REMOVED******REMOVED***agentsUsed:***REMOVED***["Calendar***REMOVED***Agent"],
***REMOVED******REMOVED******REMOVED******REMOVED***resultCount:***REMOVED***0,
***REMOVED******REMOVED***},
***REMOVED******REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***id:***REMOVED***"task-005",
***REMOVED******REMOVED******REMOVED******REMOVED***command:***REMOVED***"Create***REMOVED***a***REMOVED***spreadsheet***REMOVED***with***REMOVED***Q4***REMOVED***sales***REMOVED***data",
***REMOVED******REMOVED******REMOVED******REMOVED***status:***REMOVED***"success",
***REMOVED******REMOVED******REMOVED******REMOVED***timestamp:***REMOVED***new***REMOVED***Date(Date.now()***REMOVED***-***REMOVED***1000***REMOVED*******REMOVED***60***REMOVED*******REMOVED***60***REMOVED*******REMOVED***24***REMOVED*******REMOVED***2),***REMOVED***//***REMOVED***2***REMOVED***days***REMOVED***ago
***REMOVED******REMOVED******REMOVED******REMOVED***duration:***REMOVED***8900,
***REMOVED******REMOVED******REMOVED******REMOVED***agentsUsed:***REMOVED***["Sheets***REMOVED***Agent",***REMOVED***"Drive***REMOVED***Agent"],
***REMOVED******REMOVED******REMOVED******REMOVED***resultCount:***REMOVED***1,
***REMOVED******REMOVED***},
];

export***REMOVED***async***REMOVED***function***REMOVED***GET(request:***REMOVED***NextRequest)***REMOVED***{
***REMOVED******REMOVED***try***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***searchParams***REMOVED***=***REMOVED***request.nextUrl.searchParams;
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***page***REMOVED***=***REMOVED***parseInt(searchParams.get("page")***REMOVED***||***REMOVED***"1");
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***limit***REMOVED***=***REMOVED***parseInt(searchParams.get("limit")***REMOVED***||***REMOVED***"20");
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***dateFrom***REMOVED***=***REMOVED***searchParams.get("dateFrom");
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***dateTo***REMOVED***=***REMOVED***searchParams.get("dateTo");
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***status***REMOVED***=***REMOVED***searchParams.get("status")***REMOVED***as***REMOVED***HistoryStatus***REMOVED***|***REMOVED***null;
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***agentType***REMOVED***=***REMOVED***searchParams.get("agentType");
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***search***REMOVED***=***REMOVED***searchParams.get("search");

***REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***Filter***REMOVED***the***REMOVED***mock***REMOVED***data
***REMOVED******REMOVED******REMOVED******REMOVED***let***REMOVED***filteredData***REMOVED***=***REMOVED***[...mockHistoryData];

***REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(dateFrom)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***fromDate***REMOVED***=***REMOVED***new***REMOVED***Date(dateFrom);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***filteredData***REMOVED***=***REMOVED***filteredData.filter((item)***REMOVED***=>***REMOVED***item.timestamp***REMOVED***>=***REMOVED***fromDate);
***REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(dateTo)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***toDate***REMOVED***=***REMOVED***new***REMOVED***Date(dateTo);
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***filteredData***REMOVED***=***REMOVED***filteredData.filter((item)***REMOVED***=>***REMOVED***item.timestamp***REMOVED***<=***REMOVED***toDate);
***REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(status)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***filteredData***REMOVED***=***REMOVED***filteredData.filter((item)***REMOVED***=>***REMOVED***item.status***REMOVED***===***REMOVED***status);
***REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(agentType)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***filteredData***REMOVED***=***REMOVED***filteredData.filter((item)***REMOVED***=>
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***item.agentsUsed.some((agent)***REMOVED***=>
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***agent.toLowerCase().includes(agentType.toLowerCase())
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***)
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***);
***REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED***if***REMOVED***(search)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***searchLower***REMOVED***=***REMOVED***search.toLowerCase();
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***filteredData***REMOVED***=***REMOVED***filteredData.filter((item)***REMOVED***=>
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***item.command.toLowerCase().includes(searchLower)
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***);
***REMOVED******REMOVED******REMOVED******REMOVED***}

***REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***Sort***REMOVED***by***REMOVED***timestamp***REMOVED***(most***REMOVED***recent***REMOVED***first)
***REMOVED******REMOVED******REMOVED******REMOVED***filteredData.sort((a,***REMOVED***b)***REMOVED***=>***REMOVED***b.timestamp.getTime()***REMOVED***-***REMOVED***a.timestamp.getTime());

***REMOVED******REMOVED******REMOVED******REMOVED***//***REMOVED***Paginate
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***startIndex***REMOVED***=***REMOVED***(page***REMOVED***-***REMOVED***1)***REMOVED*******REMOVED***limit;
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***endIndex***REMOVED***=***REMOVED***startIndex***REMOVED***+***REMOVED***limit;
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***paginatedData***REMOVED***=***REMOVED***filteredData.slice(startIndex,***REMOVED***endIndex);
***REMOVED******REMOVED******REMOVED******REMOVED***const***REMOVED***hasMore***REMOVED***=***REMOVED***endIndex***REMOVED***<***REMOVED***filteredData.length;

***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***NextResponse.json({
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***items:***REMOVED***paginatedData,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***hasMore,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***total:***REMOVED***filteredData.length,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***page,
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***limit,
***REMOVED******REMOVED******REMOVED******REMOVED***});
***REMOVED******REMOVED***}***REMOVED***catch***REMOVED***(error)***REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED***console.error("Error***REMOVED***fetching***REMOVED***history:",***REMOVED***error);
***REMOVED******REMOVED******REMOVED******REMOVED***return***REMOVED***NextResponse.json(
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***{
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***message:***REMOVED***"Failed***REMOVED***to***REMOVED***fetch***REMOVED***history",
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***error:***REMOVED***error***REMOVED***instanceof***REMOVED***Error***REMOVED***?***REMOVED***error.message***REMOVED***:***REMOVED***"Unknown***REMOVED***error",
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***},
***REMOVED******REMOVED******REMOVED******REMOVED******REMOVED******REMOVED***{***REMOVED***status:***REMOVED***500***REMOVED***}
***REMOVED******REMOVED******REMOVED******REMOVED***);
***REMOVED******REMOVED***}
}
