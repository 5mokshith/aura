"useclient";

importReact,{useEffect,useState}from"react";
import{useHistory}from"@/contexts/HistoryContext";
import{useWorkflow}from"@/contexts/WorkflowContext";
importtype{TaskHistoryEntry,WorkflowStep}from"@/types";
import{
Dialog,
DialogContent,
DialogDescription,
DialogHeader,
DialogTitle,
}from"@/components/ui/dialog";
import{Button}from"@/components/ui/button";
import{
CheckCircle2,
XCircle,
Ban,
Clock,
Play,
ChevronDown,
ChevronRight,
Loader2,
}from"lucide-react";
import{cn}from"@/lib/utils";

interfaceTaskDetailModalProps{
taskId:string|null;
open:boolean;
onOpenChange:(open:boolean)=>void;
}

exportfunctionTaskDetailModal({
taskId,
open,
onOpenChange,
}:TaskDetailModalProps){
const{getTaskDetail,rerunTask}=useHistory();
const{executeWorkflow}=useWorkflow();
const[taskDetail,setTaskDetail]=useState<TaskHistoryEntry|null>(null);
const[isLoading,setIsLoading]=useState(false);
const[isRerunning,setIsRerunning]=useState(false);
const[expandedSteps,setExpandedSteps]=useState<Set<string>>(newSet());

useEffect(()=>{
if(open&&taskId){
loadTaskDetail();
}
},[open,taskId]);

constloadTaskDetail=async()=>{
if(!taskId)return;

setIsLoading(true);
try{
constdetail=awaitgetTaskDetail(taskId);
setTaskDetail(detail);
}catch(error){
console.error("Failedtoloadtaskdetail:",error);
}finally{
setIsLoading(false);
}
};

consthandleRerun=async()=>{
if(!taskDetail)return;

setIsRerunning(true);
try{
//Executethesamecommand
awaitexecuteWorkflow(taskDetail.command);
onOpenChange(false);
}catch(error){
console.error("Failedtoreruntask:",error);
}finally{
setIsRerunning(false);
}
};

consttoggleStepExpanded=(stepId:string)=>{
setExpandedSteps((prev)=>{
constnewSet=newSet(prev);
if(newSet.has(stepId)){
newSet.delete(stepId);
}else{
newSet.add(stepId);
}
returnnewSet;
});
};

constgetStatusIcon=(status:string)=>{
switch(status){
case"completed":
return<CheckCircle2className="h-5w-5text-green-600"/>;
case"failed":
return<XCircleclassName="h-5w-5text-red-600"/>;
case"cancelled":
return<BanclassName="h-5w-5text-gray-500"/>;
case"running":
return<Loader2className="h-5w-5text-blue-600animate-spin"/>;
default:
return<ClockclassName="h-5w-5text-gray-400"/>;
}
};

constformatDuration=(start?:Date,end?:Date)=>{
if(!start||!end)return"N/A";
constms=end.getTime()-start.getTime();
constseconds=Math.floor(ms/1000);
if(seconds<60){
return`${seconds}s`;
}
constminutes=Math.floor(seconds/60);
constremainingSeconds=seconds%60;
return`${minutes}m${remainingSeconds}s`;
};

constrenderStepDetail=(step:WorkflowStep)=>{
constisExpanded=expandedSteps.has(step.id);

return(
<divkey={step.id}className="borderrounded-lgp-4">
<button
className="flexitems-startgap-3cursor-pointerw-fulltext-leftfocus:outline-nonefocus:ring-2focus:ring-ringfocus:ring-offset-2rounded-mdp-2-m-2"
onClick={()=>toggleStepExpanded(step.id)}
aria-expanded={isExpanded}
aria-label={`${step.agentName}:${step.action}.${isExpanded?'Collapse':'Expand'}details`}
>
<divclassName="flex-shrink-0mt-0.5"aria-hidden="true">{getStatusIcon(step.status)}</div>

<divclassName="flex-1min-w-0">
<divclassName="flexitems-centergap-2">
<h4className="text-smfont-semibold">{step.agentName}</h4>
<spanclassName="text-xstext-muted-foreground">
{formatDuration(step.startTime,step.endTime)}
</span>
</div>
<pclassName="text-smtext-muted-foregroundmt-1">{step.action}</p>
</div>

<divclassName="flex-shrink-0"aria-hidden="true">
{isExpanded?(
<ChevronDownclassName="h-4w-4text-muted-foreground"/>
):(
<ChevronRightclassName="h-4w-4text-muted-foreground"/>
)}
</div>
</button>

{isExpanded&&(
<divclassName="mt-4space-y-3pl-8">
{step.input&&(
<div>
<h5className="text-xsfont-semiboldtext-muted-foregroundmb-1">
Input
</h5>
<preclassName="text-xsbg-mutedp-2roundedoverflow-x-auto">
{JSON.stringify(step.input,null,2)}
</pre>
</div>
)}

{step.output&&(
<div>
<h5className="text-xsfont-semiboldtext-muted-foregroundmb-1">
Output
</h5>
<preclassName="text-xsbg-mutedp-2roundedoverflow-x-auto">
{JSON.stringify(step.output,null,2)}
</pre>
</div>
)}

{step.error&&(
<div>
<h5className="text-xsfont-semiboldtext-red-600mb-1">
Error
</h5>
<divclassName="text-xsbg-red-50text-red-700p-2rounded">
{step.error}
</div>
</div>
)}
</div>
)}
</div>
);
};

return(
<Dialogopen={open}onOpenChange={onOpenChange}>
<DialogContentclassName="max-w-3xlmax-h-[80vh]overflow-y-auto"aria-describedby="task-detail-description">
<DialogHeader>
<DialogTitle>WorkflowExecutionDetails</DialogTitle>
<DialogDescriptionid="task-detail-description">
Viewcompleteexecutiondetailsandresults
</DialogDescription>
</DialogHeader>

{isLoading?(
<divclassName="flexitems-centerjustify-centerpy-12">
<Loader2className="h-8w-8animate-spintext-primary"/>
</div>
):taskDetail?(
<divclassName="space-y-6">
{/*Command*/}
<div>
<h3className="text-smfont-semiboldmb-2">Command</h3>
<divclassName="bg-mutedp-3rounded-lg">
<pclassName="text-sm">{taskDetail.command}</p>
</div>
</div>

{/*Metadata*/}
<divclassName="gridgrid-cols-2gap-4">
<div>
<h3className="text-xsfont-semiboldtext-muted-foregroundmb-1">
Status
</h3>
<divclassName="flexitems-centergap-2">
{getStatusIcon(taskDetail.workflowState.status)}
<spanclassName="text-smcapitalize">
{taskDetail.workflowState.status}
</span>
</div>
</div>
<div>
<h3className="text-xsfont-semiboldtext-muted-foregroundmb-1">
Duration
</h3>
<pclassName="text-sm">
{formatDuration(
taskDetail.workflowState.startTime,
taskDetail.workflowState.endTime
)}
</p>
</div>
<div>
<h3className="text-xsfont-semiboldtext-muted-foregroundmb-1">
Started
</h3>
<pclassName="text-sm">
{taskDetail.workflowState.startTime?.toLocaleString()||"N/A"}
</p>
</div>
<div>
<h3className="text-xsfont-semiboldtext-muted-foregroundmb-1">
Completed
</h3>
<pclassName="text-sm">
{taskDetail.workflowState.endTime?.toLocaleString()||"N/A"}
</p>
</div>
</div>

{/*ErrorMessage*/}
{taskDetail.workflowState.error&&(
<div>
<h3className="text-smfont-semiboldtext-red-600mb-2">
Error
</h3>
<divclassName="bg-red-50text-red-700p-3rounded-lg">
<pclassName="text-sm">{taskDetail.workflowState.error}</p>
</div>
</div>
)}

{/*Steps*/}
<div>
<h3className="text-smfont-semiboldmb-3">
ExecutionSteps({taskDetail.workflowState.steps.length})
</h3>
<divclassName="space-y-2">
{taskDetail.workflowState.steps.map((step)=>
renderStepDetail(step)
)}
</div>
</div>

{/*Results*/}
{taskDetail.workflowState.results.length>0&&(
<div>
<h3className="text-smfont-semiboldmb-3">
Results({taskDetail.workflowState.results.length})
</h3>
<divclassName="space-y-2">
{taskDetail.workflowState.results.map((result)=>(
<div
key={result.id}
className="borderrounded-lgp-3hover:bg-muted/50transition-colors"
>
<divclassName="flexitems-startjustify-between">
<divclassName="flex-1">
<h4className="text-smfont-medium">{result.title}</h4>
{result.preview&&(
<pclassName="text-xstext-muted-foregroundmt-1line-clamp-2">
{result.preview}
</p>
)}
</div>
{result.url&&(
<Button
variant="outline"
size="sm"
onClick={()=>window.open(result.url,"_blank")}
>
Open
</Button>
)}
</div>
</div>
))}
</div>
</div>
)}

{/*Actions*/}
<divclassName="flexjustify-endgap-2pt-4border-t">
<Button
variant="outline"
onClick={()=>onOpenChange(false)}
>
Close
</Button>
<Button
onClick={handleRerun}
disabled={isRerunning}
className="flexitems-centergap-2"
>
{isRerunning?(
<>
<Loader2className="h-4w-4animate-spin"/>
Rerunning...
</>
):(
<>
<PlayclassName="h-4w-4"/>
Re-run
</>
)}
</Button>
</div>
</div>
):(
<divclassName="text-centerpy-12">
<pclassName="text-muted-foreground">Tasknotfound</p>
</div>
)}
</DialogContent>
</Dialog>
);
}
