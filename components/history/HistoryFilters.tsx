"useclient";

importReact,{useState,useEffect}from"react";
import{useHistory}from"@/contexts/HistoryContext";
importtype{HistoryStatus,HistoryFiltersasHistoryFiltersType}from"@/types";
import{Search,Filter,X,Calendar}from"lucide-react";
import{Button}from"@/components/ui/button";
import{Input}from"@/components/ui/input";
import{
Select,
SelectContent,
SelectItem,
SelectTrigger,
SelectValue,
}from"@/components/ui/select";
import{cn}from"@/lib/utils";

exportfunctionHistoryFilters(){
const{filters,setFilters}=useHistory();
const[isExpanded,setIsExpanded]=useState(false);
const[localFilters,setLocalFilters]=useState<HistoryFiltersType>(filters);
const[searchInput,setSearchInput]=useState(filters.searchQuery||"");

//Debouncesearchinput
useEffect(()=>{
consttimer=setTimeout(()=>{
setLocalFilters((prev)=>({
...prev,
searchQuery:searchInput||undefined,
}));
},300);

return()=>clearTimeout(timer);
},[searchInput]);

//ApplyfilterswhenlocalFilterschange
useEffect(()=>{
setFilters(localFilters);
},[localFilters,setFilters]);

consthandleStatusChange=(value:string)=>{
setLocalFilters((prev)=>({
...prev,
status:value==="all"?undefined:(valueasHistoryStatus),
}));
};

consthandleAgentTypeChange=(value:string)=>{
setLocalFilters((prev)=>({
...prev,
agentType:value==="all"?undefined:value,
}));
};

consthandleDateFromChange=(e:React.ChangeEvent<HTMLInputElement>)=>{
constvalue=e.target.value;
setLocalFilters((prev)=>({
...prev,
dateFrom:value?newDate(value):undefined,
}));
};

consthandleDateToChange=(e:React.ChangeEvent<HTMLInputElement>)=>{
constvalue=e.target.value;
setLocalFilters((prev)=>({
...prev,
dateTo:value?newDate(value):undefined,
}));
};

constclearFilters=()=>{
setLocalFilters({});
setSearchInput("");
};

consthasActiveFilters=
localFilters.status||
localFilters.agentType||
localFilters.dateFrom||
localFilters.dateTo||
localFilters.searchQuery;

constformatDateForInput=(date?:Date)=>{
if(!date)return"";
returndate.toISOString().split("T")[0];
};

return(
<sectionclassName="space-y-4"aria-label="Historyfilters">
{/*SearchBar*/}
<divclassName="flexgap-2">
<divclassName="relativeflex-1">
<SearchclassName="absoluteleft-3top-1/2h-4w-4-translate-y-1/2text-muted-foreground"aria-hidden="true"/>
<Input
type="search"
placeholder="Searchcommands..."
value={searchInput}
onChange={(e)=>setSearchInput(e.target.value)}
className="pl-9"
aria-label="Searchworkflowcommands"
/>
</div>
<Button
variant={isExpanded?"default":"outline"}
size="default"
onClick={()=>setIsExpanded(!isExpanded)}
className="flexitems-centergap-2"
aria-expanded={isExpanded}
aria-label={`${isExpanded?'Hide':'Show'}filteroptions${hasActiveFilters?`(${[localFilters.status,localFilters.agentType,localFilters.dateFrom,localFilters.dateTo].filter(Boolean).length}active)`:''}`}
>
<FilterclassName="h-4w-4"aria-hidden="true"/>
Filters
{hasActiveFilters&&(
<spanclassName="ml-1flexh-5w-5items-centerjustify-centerrounded-fullbg-primary-foregroundtext-xsfont-semiboldtext-primary"aria-hidden="true">
{[
localFilters.status,
localFilters.agentType,
localFilters.dateFrom,
localFilters.dateTo,
].filter(Boolean).length}
</span>
)}
</Button>
</div>

{/*ExpandedFilters*/}
{isExpanded&&(
<divclassName="rounded-lgborderbg-cardp-4space-y-4"role="region"aria-label="Advancedfilteroptions">
<divclassName="flexitems-centerjustify-between">
<h3className="text-smfont-semibold">FilterOptions</h3>
{hasActiveFilters&&(
<Button
variant="ghost"
size="sm"
onClick={clearFilters}
className="h-8text-xs"
aria-label="Clearallfilters"
>
<XclassName="h-3w-3mr-1"aria-hidden="true"/>
ClearAll
</Button>
)}
</div>

<divclassName="gridgrid-cols-1md:grid-cols-2lg:grid-cols-4gap-4">
{/*StatusFilter*/}
<divclassName="space-y-2">
<labelhtmlFor="status-filter"className="text-xsfont-mediumtext-muted-foreground">
Status
</label>
<Select
value={localFilters.status||"all"}
onValueChange={handleStatusChange}
>
<SelectTriggerid="status-filter"aria-label="Filterbystatus">
<SelectValueplaceholder="Allstatuses"/>
</SelectTrigger>
<SelectContent>
<SelectItemvalue="all">Allstatuses</SelectItem>
<SelectItemvalue="success">Success</SelectItem>
<SelectItemvalue="failed">Failed</SelectItem>
<SelectItemvalue="cancelled">Cancelled</SelectItem>
</SelectContent>
</Select>
</div>

{/*AgentTypeFilter*/}
<divclassName="space-y-2">
<labelhtmlFor="agent-filter"className="text-xsfont-mediumtext-muted-foreground">
AgentType
</label>
<Select
value={localFilters.agentType||"all"}
onValueChange={handleAgentTypeChange}
>
<SelectTriggerid="agent-filter"aria-label="Filterbyagenttype">
<SelectValueplaceholder="Allagents"/>
</SelectTrigger>
<SelectContent>
<SelectItemvalue="all">Allagents</SelectItem>
<SelectItemvalue="email">EmailAgent</SelectItem>
<SelectItemvalue="drive">DriveAgent</SelectItem>
<SelectItemvalue="docs">DocsAgent</SelectItem>
<SelectItemvalue="sheets">SheetsAgent</SelectItem>
<SelectItemvalue="calendar">CalendarAgent</SelectItem>
<SelectItemvalue="analysis">AnalysisAgent</SelectItem>
</SelectContent>
</Select>
</div>

{/*DateFromFilter*/}
<divclassName="space-y-2">
<labelhtmlFor="date-from-filter"className="text-xsfont-mediumtext-muted-foreground">
FromDate
</label>
<divclassName="relative">
<CalendarclassName="absoluteleft-3top-1/2h-4w-4-translate-y-1/2text-muted-foregroundpointer-events-none"aria-hidden="true"/>
<Input
id="date-from-filter"
type="date"
value={formatDateForInput(localFilters.dateFrom)}
onChange={handleDateFromChange}
className="pl-9"
aria-label="Filterfromdate"
/>
</div>
</div>

{/*DateToFilter*/}
<divclassName="space-y-2">
<labelhtmlFor="date-to-filter"className="text-xsfont-mediumtext-muted-foreground">
ToDate
</label>
<divclassName="relative">
<CalendarclassName="absoluteleft-3top-1/2h-4w-4-translate-y-1/2text-muted-foregroundpointer-events-none"aria-hidden="true"/>
<Input
id="date-to-filter"
type="date"
value={formatDateForInput(localFilters.dateTo)}
onChange={handleDateToChange}
className="pl-9"
aria-label="Filtertodate"
/>
</div>
</div>
</div>
</div>
)}
</section>
);
}
